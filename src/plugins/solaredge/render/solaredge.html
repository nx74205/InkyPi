{% extends "plugin.html" %}

{% block content %}

<div class="grid-container">
    <div class="box battery-tile">
      <div class="tile-row">
        <img class="tile-icon" src="{{battery.icon}}" alt="{{battery.level}}">
        <div class="tile-description">{{battery.capacity}}</div>
      </div>
      <div class="tile-value1">{{battery.current_power}}</div>
      <div class="tile-value2">{{battery.level}}</div>
    </div>
    <div class="box solar-tile">
      <div class="tile-row">
        <img class="tile-icon" src="{{solar.icon}}" alt="SOLAR">
        <div class="tile-description">{{solar.max_power}}</div>
      </div>
      <div class="tile-value1">{{solar.current_power}}</div>
      <div class="tile-value2">{{solar.production_today}}</div>
    </div>
    <div class="box chart">
      <canvas id="solarChart"></canvas>
    </div>
    <div class="box import-tile">
      <div class="tile-row">
        <img class="tile-icon" src="{{power_plant.icon}}" alt="Import">
        <div class="tile-description"></div>
      </div>
      <div class="tile-value1"></div>
      <div class="tile-value2">{{power_plant.consumption_today}}</div>
    </div>
    <div class="box icon-tile">
      <img class="title-icon" src="{{solaredge_png}}" alt="{{Solaredge}}">
    </div>
    <div class="box current-dap">
      <div class="tile-row">
        <img class="tile-icon" src="{{dap.icon}}" alt="{{dap.currency_symbol}}">
        <div class="small-tile-description">{{dap.current_time}}</div>        
      </div>      
      <div class="small-tile-value">{{dap.current_price}}</div>
    </div>
    <div class="box next-dap">
      <div class="tile-row">
        <img class="tile-icon" src="{{dap.icon}}" alt="{{dap.currency_symbol}}">
        <div class="small-tile-description">{{dap.next_time}}</div>        
      </div>      
      <div class="small-tile-value">{{dap.next_price}}</div>
    </div>
    <div class="box renewable-tile">
      <div class="tile-row">
        <img class="tile-icon" src="{{renewable.icon}}" alt="REN">
        <div class="small-tile-description">{{renewable.description}}</div>
      </div>      
      <div class="small-tile-value">{{renewable.percentage}}</div>
    </div>
    <div class="box free-tile">
      <img class="free-tile-icon" src="{{star_png}}" alt="REN">
    </div>
    <div class="box date-tile">
      <p>{{current_date.day}}</p>
      <p>{{current_date.month}}</p>
    </div>
    <div class="box time-tile">
      <p>{{current_date.time}}</p>
      <p>{{current_date.am_pm}}</p>
    </div>

  </div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
      const canvas = document.getElementById('solarChart');
      const ctx = canvas.getContext('2d');

      const canvasPaddingPercent = 5; // 5% padding
      const canvasWidth = canvas.width * (1 - canvasPaddingPercent / 100 * 2);
      const canvasHeight = canvas.height * (1 - canvasPaddingPercent / 100 * 2);
      const offsetX = canvas.width * (canvasPaddingPercent / 100);
      const offsetY = canvas.height * (canvasPaddingPercent / 100);

      //ctx.fillText(canvasWidth, 10, 10);
      //ctx.fillText(canvasHeight, 10, 20);
      
      const totalBars = {{ chart.values_shown }};
      var barWidth = canvasWidth / totalBars -2;
      var height = canvasHeight;

      const pvData = [{% for value in chart.data %}{{ value }}{% if not loop.last %}, {% endif %}{% endfor %}];
      const maxPvValue = {{ chart.max_value }};
      const startIndex = (24 - totalBars)/2;

      ctx.fillStyle = 'red';    
      pvData.forEach((value, index) => {
        if (index >= startIndex && index < startIndex + totalBars) {
            const barHeight = (value / maxPvValue) * canvasHeight;
            const x = (index - startIndex) * (barWidth + 2) + offsetX;
            const y = canvasHeight - (barHeight + offsetY);
          
            ctx.fillRect(x, y, barWidth, barHeight);
        }
      });
      
      
  });
</script>  

{% endblock %}
